name: CI k8s

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v[0-9]+'
  pull_request:
    #paths:
    #  - k8s/*

jobs:
  verify_docker:
    runs-on: ubuntu-latest
    steps:
      - id: install
        name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest
      - id: checkout
        name: Checkout sources
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            k8s
      - name: mkdir
        run: mkdir ./build
      - name: Debug version
        run: kubectl version --client=true --output=json
      - id: bake-local
        name: Bake manifest of local
        #uses: azure/k8s-bake@v3
        run: kubectl kustomize ./k8s/live/local/ -o build/k8s-local.yml
      - id: upload-artifact-local
        name: Save build local
        uses: actions/upload-artifact@v4
        with:
          name: k8s-local.yml
          path: build/k8s-local.yml
          compression-level: 0
          if-no-files-found: error
      - id: bake-azure-dev
        name: Bake manifest of azure-dev
        run: kubectl kustomize ./k8s/live/azure-dev/ -o build/k8s-azure-dev.yml
      - id: upload-artifact-azure-dev
        name: Save build azure-dev
        uses: actions/upload-artifact@v4
        with:
          name: azure-dev.yml
          path: build/k8s-azure-dev.yml
          compression-level: 0
          if-no-files-found: error
      - id: bake-azure-integ
        name: Bake manifest of azure-integ
        run: kubectl kustomize ./k8s/live/azure-integ/ -o build/k8s-azure-integ.yml
      - id: upload-artifact-azure-integ
        name: Save build integ
        uses: actions/upload-artifact@v4
        with:
          name: azure-integ.yml
          path: build/k8s-azure-integ.yml
          compression-level: 0
          if-no-files-found: error
