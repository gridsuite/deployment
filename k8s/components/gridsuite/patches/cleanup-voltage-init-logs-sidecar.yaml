apiVersion: apps/v1
kind: Deployment
metadata:
  name: not-important
spec:
  template:
    spec:
      containers:
        - name: cleanup
          image: docker.io/busybox:1.36.1@sha256:9ae97d36d26566ff84e8893c64a6dc4fe8ca6d1144bf5b87b2b85a32def253c7
          volumeMounts:
            - mountPath: /tmp
              name: tmp-emptydir
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
          command:
            - "/bin/sh"
            - "-c"
            - |
              while true; do
                total_size=$(du -s /tmp | awk '{print $1}')
                # Keep the 5 most recent log directories if size is above 400Mi
                if [ $total_size -gt 400000 ]; then
                  echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") - Cleaning up /tmp..."
                  ls -dt /tmp/ampl_* 2>/dev/null | tail -n +6 | xargs -rI {} sh -c 'echo Deleting {}; rm -rf "{}"'
                  echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ") - Cleanup completed."
                fi
                sleep 60
              done
