apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
# Set all large memory sizes to memory-xs (need separate patches since annotationSelector uses AND logic)
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-s
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-m
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-l
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-l-forking
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-xl
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-xl-forking
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-xxl
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-xxl-forking
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot
    annotationSelector: gridsuite.org/memory=memory-xxxl
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs

- target:
    kind: Deployment
    labelSelector: name=security-analysis-server
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: not-important
      annotations:
        gridsuite.org/memory: memory-xs


  # remove cpu requests/limits annotations (except security-analysis-server which has hardcoded resources)
- target:
    kind: Deployment
    labelSelector: app.kubernetes.io/component=gridsuite-springboot,name!=security-analysis-server
  patch: |-
    - op: remove
      path: /metadata/annotations/gridsuite.org~1cpu

  # remove hardcoded cpu and memory requests/limits for security-analysis-server
- target:
    kind: Deployment
    labelSelector: name=security-analysis-server
  patch: |-
    - op: remove
      path: /spec/template/spec/containers/0/resources
